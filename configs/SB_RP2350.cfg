#####################################################################
#      Master ID Configuration
#####################################################################
[mcu SB_RP2350]  # 工具主板序列号
canbus_uuid: 626c12f2f324

#####################################################################
#      Temperature monitoring
#####################################################################
[temperature_sensor SB_RP2350]
sensor_type: temperature_mcu
sensor_mcu: SB_RP2350


# [temperature_sensor SB头温湿度AHT20]
# sensor_type: AHT10
# i2c_address: 56 #0x38
# i2c_mcu: SB_RP2350
# i2c_bus: i2c1e
# i2c_speed: 400000

# # # #   See the "common I2C settings" section for a description of the above parameters.
# aht10_report_time: 5
# #   Interval in seconds between readings. Default is 30, minimum is 5

# [temperature_sensor SB头温湿度SHT3X]
# sensor_type: SHT3X
# i2c_address: 68       #(0x44)
# i2c_mcu: SB_RP2350
# # i2c_bus: i2c1b
# i2c_software_scl_pin: SB_RP2350:gpio7
# i2c_software_sda_pin: SB_RP2350:gpio6
# # i2c_bus: i2c2
# i2c_speed: 100000

# [gcode_macro QUERY_SHT35]
# gcode:
#     {% set sensor = printer["sht3x SB头温湿度SHT3X"] %}
#     {action_respond_info(
#         "Temperature: %.2f C\n"
#         "Humidity: %.2f%%" % (
#             sensor.temperature,
#             sensor.humidity))}
#     # {action_respond_info("Humidity2  %s" %(printer['temperature_sensor iDryer_U1_Air'].humidity|int))}
            

# [temperature_sensor SGP40]
# sensor_type: SGP40
# i2c_address: 89
# i2c_mcu: SB_RP2350
# #i2c_bus: i2c1e
# i2c_software_scl_pin: SB_RP2350:gpio6
# i2c_software_sda_pin: SB_RP2350:gpio7
# ref_temp_sensor: sht3x SB头温湿度SHT3X
# ref_humidity_sensor: sht3x SB头温湿度SHT3X
# i2c_speed: 100000
# #sampling_interval: 1.0
# # # soft_reset_on_startup: True

#####################################################################
#      Stealthburner LED
#####################################################################
## https://github.com/VoronDesign/Voron-Stealthburner/tree/main
[neopixel sb_leds]
pin: SB_RP2350:gpio26
chain_count: 3
# Number of LEDs
# 灯珠数量
color_order: GRBW
initial_RED: 0.4
initial_GREEN: 0.8
initial_BLUE: 1
initial_WHITE: 0.0

#####################################################################
#      Extruder thermal sensitivity
#####################################################################
## Please select the type of thermocouple you want to use.
## 请根据你想要使用的热敏选择
[extruder]
## Type of sensor - common thermistors are (Generic 3950, ATC Semitec 104GT-2)
## 传感器类型-常见的热敏电阻器是 (Generic 3950, ATC Semitec 104GT-2)
sensor_type: Generic 3950
sensor_pin: SB_RP2350:gpio28
###------------------------------------------------------------------
## If using PT1000, please connect the jumper next to the thermal sensitivity.
## 如果使用PT1000请将热敏旁边跳线接上
# sensor_type:PT1000
# sensor_pin:SHT36:gpio27
# pullup_resistor: 1000
###------------------------------------------------------------------
## Using MAX31865 to connect PT100 or PT1000
## 使用MAX31865接PT100或者PT1000
# sensor_type: MAX31865
# sensor_pin: SHT36:gpio17
# spi_software_sclk_pin: SHT36:gpio2
# spi_software_mosi_pin: SHT36:gpio3
# spi_software_miso_pin: SHT36:gpio4
# rtd_reference_r: 430  ## 使用PT100时请设置为430，使用PT1000时请设置为4300
#  Z调平传感器单点探测宏
#####################################################################





    
#####################################################################
#      extruder
#####################################################################
## https://www.klipper3d.org/Config_Reference.html#extruder
[extruder]
step_pin: SB_RP2350:gpio14
dir_pin: SB_RP2350:gpio13
enable_pin: !SB_RP2350:gpio16
rotation_distance: 46.579  #46.255    #47.088          #13.466
## rotation_distance = The original rotation_distance multiplied by the actual extrusion length divided by the requested extrusion length.
## 校准步进值: 22.44=旧值22*实际值102/目标值100
gear_ratio: 9:1             #50:17
## 减速比（伽利略齿比7.5:1 并且这行注释掉；BMG为50：17，输出轴在前，输入轴在后）
microsteps: 32
full_steps_per_rotation: 200   
nozzle_diameter:0.400
filament_diameter:1.75
heater_pin: SB_RP2350:gpio23
min_temp: -200
max_temp: 350
max_power: 1.0
min_extrude_temp: -200
pressure_advance: 0.05
#压力提前调整方法:https://www.klipper3d.org/zh/Pressure_Advance.html
pressure_advance_smooth_time: 0.040 # 平稳推进时间-默认值为0.040
max_extrude_only_distance: 200.0   # 挤出流量报错可以注释这个，但是建议重新切片
#max_extrude_only_distance: 200.0   # 挤出流量报错可以注释这个，但是建议重新切片
#喷嘴温度PID校准命令：  "PID_CALIBRATE HEATER=extruder TARGET=245  
control: pid
pid_Kp: 44.540
pid_Ki: 21.208
pid_Kd: 23.384

##------------------------------------------------------
[tmc2209 extruder]
uart_pin: SB_RP2350:gpio15
interpolate: False
run_current: 0.80
sense_resistor:0.110
stealthchop_threshold:0
###------------------------------------------------------------------
[verify_heater extruder]
max_error: 20
check_gain_time:120
hysteresis: 50
heating_gain: 2


#####################################################################
#      FAN
#####################################################################
[fan]
# pin: SB_RP2350:gpio21
# hardware_pwm: True
# kick_start_time: 0.2         # 启动时间（勿动）
# max_power: 0.1                   # 最大转速
# off_below: 0.10              # 勿动

pin: !SB_RP2350:gpio10
#   控制风扇的输出引脚。必须提供此参数。
max_power: 1.0
#   引脚可以设置的最大功率（以0.0到1.0的值表示）。1.0的值允许引脚完全
#   启用，而0.5的值则最多只能启用一半的时间。此设置可用于限制风扇的总
#   功率输出（在延长时间内）。如果此值小于1.0，则风扇速度请求将在零和
#   最大功率之间进行缩放（例如，如果最大功率为.9且请求的风扇速度为80%，
#   则风扇功率将被设置为72%）。
#   默认值为1.0。
#shutdown_speed: 0
#   微控制器软件进入错误状态时的风扇速度（以0.0到1.0的值表示）。
#   默认值为0。
cycle_time: 0.010
#   每个PWM电源周期到风扇的时间（以秒为单位）。当使用基于软件
#   的PWM时，建议此值为10毫秒或更大。
#   默认值为0.010秒。
hardware_pwm: True
#   启用此选项以使用硬件PWM而非软件PWM。大多数风扇不适合使用
#   硬件PWM，因此除非有电气需求以非常高的速度切换，否则不建议
#   启用此功能。当使用硬件PWM时，实际的周期时间受到实现的限制，
#   可能与请求的周期时间有很大的不同。
#   默认值为False。
kick_start_time: 0.100
#   风扇全速运行的时间（以秒为单位），当首次启用或增加超过50%时
#   （有助于使风扇开始旋转）。
#   默认值为0.100秒。
off_below: 0.0
#   将供电给风扇的最小输入速度（以0.0到1.0的值表示）。当请求低于
#   off_below的速度时，风扇将被关闭。此设置可以用于防止风扇停滞，
#   并确保起动开始有效。
#   默认值为0.0。
#
#   每次调整max_power时，都应重新校准此设置。为校准此设置，以
#   off_below设置为0.0和风扇旋转开始。逐渐降低风扇速度，确定
#   可可靠驱动风扇且不停滞的最低输入速度。将off_below设置为对应
#   于此值的占空比（例如，12% -> 0.12）或稍高。
tachometer_pin: ^SB_RP2350:gpio11
#   用于监控风扇速度的转速计输入引脚。通常需要上拉。此参数是可
#   选的。
tachometer_ppr: 2
#   当指定了转速计引脚时，这是转速计信号每转一圈的脉冲数。对于
#   BLDC风扇，这通常是极数的一半。
#   默认值是2。
tachometer_poll_interval: 0.0015
#   当指定了转速计引脚时，这是转速计引脚的轮询周期，以秒为单位。
#   默认值是0.0015，对于2PPR以下的10000转/分钟的风扇来说已经足够
#   快了。这个值必须小于30/(转速计_ppr*rpm)，并且有一些余量，其中
#   rpm是风扇的最大速度（以RPM为单位）。
#enable_pin:
#   可选引脚，用于使风扇供电。对于具有专用PWM输入的风扇，这可以
#   很有用。这些风扇即使在0% PWM输入下也会保持开启。在这种情况下，
#   PWM引脚可以使用，例如，可以使用接地开关的FET（标准风扇引脚）
#   来控制风扇的电源。


###------------------------------------------------------------------
[heater_fan 喉管散热]         # 喉管冷却风扇
pin: SB_RP2350:gpio19           # 信号接口
max_power: 1.0               # 最大转速
kick_start_time: 0.5         # 启动时间（勿动）
heater: extruder             # 关联的设备：挤出机
heater_temp: 60              # 挤出机达到多少度启动风扇
fan_speed: 1.0               # 风扇转速

[temperature_fan SB-TMC2226]
pin: SB_RP2350:gpio24
max_power: 1.0
#shutdown_speed: 0
sensor_type: Generic 3950 #ATC Semitec 104GT-2      #SDNT1005X473F4050FTF
sensor_pin: SB_RP2350:gpio29    # 热床传感器类型
#pullup_resistor: 10000
control: watermark
kick_start_time: 0.5
min_temp: -20
max_temp: 150
max_delta: 3.0
target_temp: 50

[temperature_sensor SB挤出电机]
sensor_type: Generic 3950 #ATC Semitec 104GT-2      #SDNT1005X473F4050FTF
sensor_pin: SB_RP2350:gpio27    # 热床传感器类型





#####################################################################
#      TAP && PL08N && BLTOUCH 
#####################################################################
[stepper_x]
endstop_pin: ^SB_RP2350:gpio17

#####################################################################
#      TAP && PL08N && BLTOUCH 
#####################################################################
## https://www.klipper3d.org/Config_Reference.html?h=probe#probe
# [probe]
# pin: ^SB_RP2350:gpio22
# x_offset: 0
# y_offset: 0
# z_offset: -1.115
# speed: 10.0
# samples: 3
# samples_result: median
# sample_retract_dist: 4.0
# samples_tolerance: 0.010
# samples_tolerance_retries: 3

# activate_gcode:
#     {% set PROBE_TEMP = 150 %}
#     {% set MAX_TEMP = PROBE_TEMP + 5 %}
#     {% set ACTUAL_TEMP = printer.extruder.temperature %}
#     {% set TARGET_TEMP = printer.extruder.target %}

#     {% if TARGET_TEMP > PROBE_TEMP %}
#         { action_respond_info('Extruder temperature target of %.1fC is too high, lowering to %.1fC' % (TARGET_TEMP, PROBE_TEMP)) }
#         M109 S{ PROBE_TEMP }
#     {% else %}
#         # Temperature target is already low enough, but nozzle may still be too hot.
#         {% if ACTUAL_TEMP > MAX_TEMP %}
#             { action_respond_info('Extruder temperature %.1fC is still too high, waiting until below %.1fC' % (ACTUAL_TEMP, MAX_TEMP)) }
#             TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={ MAX_TEMP }
#         {% endif %}
#     {% endif %}
    
#--------------------------------------------------------------------
## https://www.klipper3d.org/Config_Reference.html?h=probe#bltouch
#[bltouch]
#sensor_pin: ^SHT36:gpio22    # 信号接口
#control_pin: SHT36:gpio24    # 舵机控制
#x_offset: -26.1              # X轴-传感器相对喷嘴偏移量，需要自行确定偏移量
#y_offset: -15.3              # Y轴-传感器相对喷嘴偏移量，需要自行确定偏移量
#z_offset: 2.1                # Z轴-传感器相对喷嘴偏移量，需要自行确定偏移量


# [probe_eddy_current fly_eddy_probe]
# sensor_type: ldc1612
# z_offset: 2
# i2c_address: 43
# i2c_mcu: SHT36
# i2c_bus: i2c1e
# #i2c_software_scl_pin: SHT36:gpio18
# #i2c_software_sda_pin: SHT36:gpio19
# x_offset: 0
# y_offset: 20
# speed:40
# lift_speed: 5

# [temperature_probe fly_eddy_probe]
# sensor_type:Generic 3950
# sensor_pin:SHT36:gpio28
# horizontal_move_z: 2
